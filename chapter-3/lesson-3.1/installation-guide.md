# Установка окружения для работы с PostgreSQL

- [Установка окружения для работы с PostgreSQL](#установка-окружения-для-работы-с-postgresql)
  - [Установка Postgres](#установка-postgres)
    - [Запуск и остановка служб Postgres](#запуск-и-остановка-служб-postgres)
    - [Настройка переменной окружения](#настройка-переменной-окружения)
  - [Установка DBeaver](#установка-dbeaver)
    - [Установка DBeaver портативной версии](#установка-dbeaver-портативной-версии)
  - [Подключение к PostgreSQL с помощью DBeaver](#подключение-к-postgresql-с-помощью-dbeaver)
  - [Разворачивание учебной базы данных с помощью DBeaver](#разворачивание-учебной-базы-данных-с-помощью-dbeaver)
    - [Создание нового пользователя](#создание-нового-пользователя)
    - [Создание новой базы данных](#создание-новой-базы-данных)
    - [Восстановление бекапа](#восстановление-бекапа)
  - [Разворачивание учебной базы данных с помощью командной строки и psql](#разворачивание-учебной-базы-данных-с-помощью-командной-строки-и-psql)
    - [Запускаем psql](#запускаем-psql)
    - [Создание нового пользователя](#создание-нового-пользователя-1)
    - [Создание новой базы данных](#создание-новой-базы-данных-1)
    - [Восстановление бекапа](#восстановление-бекапа-1)

## Установка Postgres

Ссылка для скачивания установочных файлов Postgres. [https://www.postgresql.org/download/](https://www.postgresql.org/download/)

Прямая ссылка на файлы для Windows [https://www.enterprisedb.com/downloads/postgres-postgresql-downloads](https://www.enterprisedb.com/downloads/postgres-postgresql-downloads)

Если актуальная версия не устанавливается, то можно воспользоваться версией 10.23 как наиболее универсальной под все платформы Windows. [https://www.enterprisedb.com/postgresql-tutorial-resources-training?uuid=e9a60157-955a-4f24-a738-07cff51ccb43&campaignId=70138000000rYFmAAM](https://www.enterprisedb.com/postgresql-tutorial-resources-training?uuid=e9a60157-955a-4f24-a738-07cff51ccb43&campaignId=70138000000rYFmAAM)

![img/postgres-download.png](./img/postgres-download.png)

Запустите скачанный файл (если запросит права администратора, нажмите "Да").

В случае отсутствия установленного на компьютере Microsoft Visual C++, установка произойдет автоматически, данный компонент необходим для работы сервера.

![Установка MVC](./img/MVC.png)

Далее произойдет открытие инсталлятора PostgreSQL Server, необходимо нажать “Next”

![Нажимаем Next >](./img/PostgreSQL1.png)

Выберите необходимый путь установки (лучше использовать предложенный)

![Выберите путь установки](./img/PostgreSQL2.png)

Далее выберите следующие пункты, изображенные на скриншоте

![Выбираем PostgreSQL Server + Command Line Tools](./img/PostgreSQL3.png)

Выберите место хранения PostgreSQL Server (лучше использовать стандартное)

![Выбираем место хранения PostgreSQL Server](./img/PostgreSQL4.png)

Укажите пароль, он потребуется при создании подключения и нажмите Next. Если запроса на создание пароля нет, значит PostgreSQL Database Server уже был установлен ранее.

**Внимание:** Этот пароль очень важен, т.к. в случае его утраты вы потеряете доступ к серверу PostgreSQL и придется осуществлять переустановку. Для учебных целей можно установить пароль `postgres`

![Указываем пароль](./img/PostgreSQL5.png)

Введите номер порта для подключения к серверу и нажмите Next (введите 5432, он считается стандартным):

![Указываем порт подключения к серверу](./img/PostgreSQL6.png)

Нажмите Next

![Нажимаем Next](./img/PostgreSQL7.png)

Нажмите Next

![Нажимаем Next](./img/PostgreSQL8.png)

Нажмите Next и дождитесь окончания установки

![Нажимаем Next](./img/PostgreSQL9.png)

Нажмите Finish

![Нажимаем Next](./img/PostgreSQL10.png)

Зайдите в Процессы Диспетчера задач (правая кнопка мыши на панели задач -> диспетчер задач) и убедитесь, что сервер запущен. В случае отсутствия, проверьте, что отображаются процессы для “всех пользователей”

![Проверяем в диспетчере задач наличие процессов PostgreSQL Server](./img/PostgreSQL11.png)

Поздравляю, вы установили PostgreSQL Server.

### Запуск и остановка служб Postgres

Для запуска и остановки сервера Postgres мы будем пользоваться службами Windows. Для этого открываем меню Пуск > Администрирование > Службы.

Если там нет такого пункта, то тогда просто открываем меню Пуск и в поле поиска вводим *Службы* или *Services*.

![Пуск - Службы](./img/services-menu.png)

Если и так не получается, то нажимаем комбинацию клавиш Win+R и в открывшемся окне вводим `services.msc`.

![Выполнить - Службы](./img/services-run.png)

В результате откроется окно всех запущенных служб и в нем можно найти наш сервер Postgres. При желании, с помощью правой кнопки мыши его можно остановить/запустить/перезапустить.

![Служба Postgres](./img/services.png)

### Настройка переменной окружения

После установки сервера PostgreSQL его настройки должны прописаться в переменные окружения, чтобы мы могли запускать команды с помощью psql.

Для проверки этого откройте терминал (в Windows комбинация клавиш Win+R и наберите `cmd`)

![cmd](./img/cmd.png)

В терминале наберите `psql -U postgres` и нажмите Enter. Если в ответ вы увидели сообщение `'psql' is not recognized as an internal or external command, operable program or batch file.` значит нужно добавить путь к установленному PostgreSQL в переменные окружения самостоятельно.

![psql error](./img/cmd-psql-error.png)

Для этого откройте Панель управления Windows, выберите *Система*, выберите *Расширенные настройки системы* и в открывшемся окне на вкладке *Расширенные* внизу нажмите кнопку *Переменные окружения*.

![Переменные окружения](./img/environment-variables.png)

В открывшемся окне в разделе *Системные переменные* ищем переменную PATH и нажимаем *Изменить*.

![Редактирование переменной окружения](./img/environment-variables-edit.png)

В появившемся окне во второй строчке дописываем через точку с запятой путь к установленному серверу PostgesSQL. По умолчанию, это `C:\Program Files\PostgreSQL\10\bin`. Важно, чтобы на конце была папка `bin`, именно в ней лежат исполняемые файлы. Нажимаем ОК.

![Добавляем переменную окружения](./img/edit-environment.png)

Во всем открытых окнах до этого тоже нажимаем ОК. Для Windows 7 необходимо перезагрузить систему, для более новых это обычно не требуется.

После перезагрузки снова открываем терминал и пробуем ввести `psql -U postgres`. Если мы все прописали верно, то нам будет предложено ввести пароль, вводим `postgres`.
(Символы не отображаются, это нормально) и нажимаем Enter. На экране появится новая строка с версией сервера и приглашением к вводу команд `postgres=#`

![psql успешно](./img/psql-success.png)

Для проверки, что все работает, можем ввести команду `SELECT version();`

![проверка версии Postgres](./img/psql-select-version.png)

Чтобы выйти из режима ввода команд psql наберите `\q` и нажмите Enter.

## Установка DBeaver

DBeaver — клиентское приложение для управления СУБД, которое даёт возможность администрировать структуру БД, выполнять запросы на SQL, получать результаты запросов, импортировать и экспортировать данные и т. д.

Преимущество DBeaver в том, что он может работать с множеством различных СУБД.

Для установки ПО переходим по ссылке [на сайт сообщества DBeaver](https://DBeaver.io) и нажимаем кнопку загрузки.

![Кнопка перехода в раздел скачивания на сайте DBeaver](./img/DBeaverDownloadButton.png)

Если актуальная версия не запускается, можно воспользоваться более старой из архива, которая работает на 32-разрядных системах, вплоть до Windows 7.

[Версия 6.0](https://DBeaver.io/files/6.0.0/DBeaver-ce-6.0.0-x86-setup.exe)

Если при попытке запуска инсталлятора у вас запрашивает права администратора (и они у вас есть) - ждем “Да” (обычно запрашивать не должно).

Нажимаем “Далее >”

![Нажимаем далее](./img/Dbeaver1.png)

Принимаем лицензионное соглашение, нажав "Принимаю"

![Принимаем соглашение](./img/Dbeaver2.png)

Далее вам необходимо определиться кому будет доступен для запуска DBeaver. Выбирайте "For me (User)" и нажмите "Далее >".

Далее вам необходимо поставить галочки напротив следующих пунктов (смотрим на скриншоте):

![Выставляем DBeaver Community, Include Java, Associate .SQL files](./img/Dbeaver3.png)

После чего нам необходимо выбрать папку установки DBeaver (желательно использовать предложенную). Нажимаем "Далее >"

![Выбираем путь установки DBeaver](./img/Dbeaver4.png)

В следующем окне жмем "Установить".

![Нажимаем установить](./img/Dbeaver5.png)

Далее инсталлятору потребуется некоторое время для установки, по окончанию нажимаем "Завершить".

### Установка DBeaver портативной версии

Можно воспользоваться и портативной версии, которая не требует установки. Достаточно будет скачать архив и распаковать его.

[Версия 6.0 портативная](https://DBeaver.io/files/6.0.0/DBeaver-ce-6.0.0-win32.win32.x86.zip)

Для запуск Portable версии необходимо разархивировать скачанный zip - архив в удобное для вас место, после чего зайти в папку DBeaver и запустить DBeaver.exe.

![Запусктите DBeaver.exe в разархивированной папке](./img/PortableDBeaver1.png)


## Подключение к PostgreSQL с помощью DBeaver

Запустите DBeaver и нажмите на кнопку "Новое соединение"

![Открываем DBeaver и нажимаем кнопку "Новое соединение"](./img/Backup1.png)

Выберите PostgreSQL и нажмите Далее

![Выбираем PostgreSQL](./img/Backup2.png)

В поле Пароль укажите тот пароль, **который указывали при установке PostgreSQL Database Server**, (в данном руководстве это был `postgres`) локальный клиент выберите PostgreSQL (*версия*) или PostgreSQL Binaries, все остальные данные остаются без изменений. Нажмите Тест соединения.

![Указываем параметры подключения](./img/Backup3.png)

DBeaver предложит скачать необходимые драйвера, нажмите Скачать

![Скачиваем необходимые драйвера](./img/Backup4.png)

Появится окно об успешном прохождении теста, нажмите ОК

![Нажимаем готово](./img/Backup5.png)

На запрос о создании образца базы данных выберите Нет

![Нажимаем "Нет"](./img/Backup6.png)

В левой части окна будет доступно подключение с пустой базой данных

![Папка с БД](./img/Backup7.png)

## Разворачивание учебной базы данных с помощью DBeaver

### Создание нового пользователя

Создадим пользователя, которого будем использовать для работы с учебной базой данных.

Для этого щелкнем правой клавишей по папке *Роли* и выберем *Создать новую роль*.

![Создание пользователя 1](./img/create-new-role-1.png)

Создадим пользователя с именем `dbuser` и паролем `dbpassword`.

![Создание пользователя 2](./img/saving-user.png)

Откроется окно детальных настроек пользователя. Внизу справа нажимаем *Сохранить*. В появившемся окне нажимаем *Применить*.

![Создание пользователя 3](./img/saving-user-2.png)

Щелкаем правой клавишей по папке *Роли* и нажимаем *Обновить*.

### Создание новой базы данных

Теперь создадим учебную базу данных, владельцем которой будет свежесозданный пользователь. Правой клавишей щелкаем на базе данных *postgres* и выбираем *Создать новую базу данных*.

![Создание новой базы данных](./img/create-new-database-1.png)

Назовем нашу базу данных `demo_db` и ее владельцем поставим пользователя `dbuser`. Нажимаем ОК.

![Создание новой базы данных](./img/create-new-database-2.png)


### Восстановление бекапа

Щелкаем правой клавишей мыши по базе данных *demo_db*, выбираем *Инструменты - Восстановить*.

![Восстановление базы данных](./img/restore-database-1.png)

В открывшемся окне выбираем формат *Custom* и файл бекапа `dump-demo_db.backup`. Нажимаем *Старт*.

![Восстановление базы данных](./img/restore-database-2.png)

Начнется процесс восстановления и по завершении появится сообщение.

## Разворачивание учебной базы данных с помощью командной строки и psql

### Запускаем psql

Откройте терминал (в Windows комбинация клавиш Win+R и наберите `cmd`)

![cmd](./img/cmd.png)

В терминале наберите `psql -U postgres` и нажмите Enter.

Будет предложено ввести пароль, вводим `postgres`.
(Символы не отображаются, это нормально) и нажимаем Enter. На экране появится новая строка с версией сервера и приглашением к вводу команд `postgres=#`

![psql успешно](./img/psql-success.png)

Если этого не произошло, необхоидимо настроить переменные окружения.

### Создание нового пользователя

В терминале вводим

```sql

CREATE USER dbuser NOSUPERUSER NOCREATEDB NOCREATEROLE NOINHERIT LOGIN PASSWORD 'dbpassword';
```

### Создание новой базы данных

В терминале вводим

```sql
CREATE DATABASE demo_db WITH OWNER = dbuser ENCODING = 'utf8' CONNECTION LIMIT = -1;
```

После создания базы данных можно выйти из psql набрав `\q` и нажав Enter.

### Восстановление бекапа

В терминале вводим

```
psql -U postgres -d demo_db -f C:\Users\rymbln\Desktop\dump-demo_db.sql
```

где `C:\User\rymbln\Desktop\dump-demo_db.sql` путь к файлу с бекапом.

Вводим пароль `postgres` и начнется восстановление.
